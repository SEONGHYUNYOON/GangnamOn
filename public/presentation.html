<!DOCTYPE html>
<html lang="ko">

<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>PajuOn DB Architecture</title>
     <script src="https://cdn.tailwindcss.com"></script>
     <script src="https://unpkg.com/lucide@latest"></script>
     <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');

          body {
               font-family: Pretendard, sans-serif;
          }

          .custom-scrollbar::-webkit-scrollbar {
               width: 6px;
          }

          .custom-scrollbar::-webkit-scrollbar-track {
               background: #f1f5f9;
          }

          .custom-scrollbar::-webkit-scrollbar-thumb {
               background-color: #cbd5e1;
               border-radius: 20px;
          }
     </style>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

     <div id="app"
          class="w-full max-w-6xl aspect-[16/9] bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col border border-slate-200/60 relative">
          <!-- Content will be injected here by JS -->
     </div>

     <script>
          const slides = [
               {
                    id: 0,
                    type: 'title',
                    title: 'PajuOn: 기술 아키텍처 심층 분석',
                    subtitle: '고도화된 DB 스키마, 구축 로직 및 백엔드 전략',
                    author: '백엔드 리드 엔지니어',
                    icon: 'server'
               },
               {
                    id: 1,
                    type: 'content',
                    title: '1. 아키텍처 원칙 (Why?)',
                    content: [
                         '단일 진실 공급원 (Single Source of Truth): 모든 핵심 상태는 클라이언트 캐시가 아닌 Postgres에 저장됩니다.',
                         'BaaS (Backend-as-a-Service): Supabase를 활용하여 DevOps 비용을 최소화하면서 SQL의 강력함은 유지합니다.',
                         '데이터 계층 보안 (Security at Data Layer): RLS(행 수준 보안)를 통해 DB 자체가 API 보안 게이트웨이 역할을 수행합니다.',
                         '낙관적 동시성 제어 (Optimistic Concurrency Control): 강력한 락(Lock) 대신 버전/타임스탬프를 사용하여 다중 사용자 쓰기 충돌을 방지합니다.'
                    ]
               },
               {
                    id: 2,
                    type: 'diagram',
                    title: '2. 인증 흐름 & 데이터 무결성',
                    description: 'Supabase Auth(GoTrue)와 애플리케이션 데이터 간의 연결 고리입니다.',
                    htmlContent: `
                <div class="flex flex-col gap-6 p-6 bg-slate-50 rounded-lg border border-slate-200 w-full max-w-2xl mx-auto">
                  <div class="flex items-center justify-between">
                     <div class="w-48 p-4 bg-gray-800 text-white rounded-lg text-center font-mono text-sm">인증 서비스<br/>(auth.users)</div>
                     <div class="flex-1 border-t-2 border-dashed border-gray-300 mx-4 relative">
                        <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-slate-50 px-2 text-xs text-gray-500">JWT 토큰 발급</span>
                     </div>
                     <div class="w-48 p-4 bg-indigo-600 text-white rounded-lg text-center font-mono text-sm">클라이언트 앱<br/>(Headers)</div>
                  </div>
                  <div class="flex justify-center">
                     <div class="bg-orange-100 text-orange-800 px-4 py-2 rounded-full text-xs font-bold border border-orange-200">⚠️ 위험: 인증 유저 vs 공개 프로필 불일치 가능성</div>
                  </div>
                  <div class="flex items-center justify-between mt-4">
                     <div class="w-48 p-4 bg-white border-2 border-green-500 rounded-lg text-center font-mono text-sm">Postgres 트리거</div>
                     <div class="flex-1 h-2 bg-green-500 mx-4 rounded-full relative">
                        <span class="absolute -top-5 left-1/2 -translate-x-1/2 text-xs font-bold text-green-700">자동 동기화 (Atomic)</span>
                     </div>
                     <div class="w-48 p-4 bg-white border border-gray-300 rounded-lg text-center font-mono text-sm">공개 스키마<br/>(public.profiles)</div>
                  </div>
                </div>`
               },
               {
                    id: 3,
                    type: 'code',
                    title: '3. 트리거를 이용한 인증 신뢰성 향상',
                    description: '클라이언트 사이드 프로필 생성이 아닌 PL/pgSQL 트리거를 사용하는 이유입니다.',
                    code: `-- 함수: 신규 유저 처리 (Handle New User)
-- Security Definer: Public 테이블에 쓰기 권한이 있는 관리자 권한으로 실행
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username, full_name, avatar_url)
  VALUES (
    new.id,
    new.raw_user_meta_data ->> 'username', -- 메타데이터에서 추출
    new.raw_user_meta_data ->> 'full_name',
    COALESCE(new.raw_user_meta_data ->> 'avatar_url', '')
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 트리거 정의 (회원가입 직후 실행)
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();`
               },
               {
                    id: 4,
                    type: 'schema',
                    title: '4. 핵심 엔티티: 프로필 스키마 설계',
                    description: '유저 프로필 테이블 설계 결정 사항입니다.',
                    tables: [
                         {
                              name: 'public.profiles',
                              columns: [
                                   'id (UUID, PK): auth.users의 ID와 1:1 매칭 (FK)',
                                   'username (TEXT, Unique): 멘션(@) 기능을 위한 고유 식별자',
                                   'manner_temp (FLOAT): 매너온도. 기본 36.5도',
                                   'beans (BIGINT): 화폐(콩). 오버플로우 방지',
                                   'unlocked_titles (TEXT[]): 칭호 목록 (배열)'
                              ]
                         }
                    ]
               },
               {
                    id: 5,
                    type: 'schema',
                    title: '5. 피드 아키텍처: 게시글 & 성능 최적화',
                    description: '읽기 중심(Read-Heavy) 워크로드를 위한 최적화 설계입니다.',
                    tables: [
                         {
                              name: 'public.posts',
                              columns: [
                                   'id (UUID, PK)',
                                   'user_id (UUID, FK, Indexed): 작성자 조회용 인덱스',
                                   'category_id (INT, Indexed): 필터링 속도 향상',
                                   'location_geo (GEOGRAPHY): PostGIS 좌표',
                                   'comment_count (INT): 역정규화(Denormalization) 필드'
                              ]
                         }
                    ],
                    bullet_content: [
                         '역정규화 이유: 피드 목록 조회 시 Count 쿼리 비용 절감 (O(N) -> O(1))'
                    ]
               },
               {
                    id: 6,
                    type: 'code',
                    title: '6. 대규모 "좋아요" 처리 전략',
                    description: '동시성 이슈 없는 "좋아요" 토글 구현 및 경쟁 조건 방지.',
                    code: `-- 좋아요 테이블
CREATE TABLE public.post_likes (
  user_id UUID REFERENCES public.profiles(id),
  post_id UUID REFERENCES public.posts(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (user_id, post_id) -- 복합 키(Composite PK)
);

-- RLS 정책: 토글 로직
CREATE POLICY "Toggle Like" ON public.post_likes
  FOR ALL
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);`
               },
               {
                    id: 7,
                    type: 'diagram',
                    title: '7. 중고 거래 상태 머신 (State Machine)',
                    description: '이중 판매를 방지하기 위한 엄격한 상태 관리 로직입니다.',
                    htmlContent: `
                <div class="flex items-center justify-around p-8 bg-gray-50 rounded-xl relative w-full max-w-3xl mx-auto">
                     <div class="z-10 bg-green-100 border-2 border-green-500 text-green-800 px-6 py-3 rounded-lg font-bold">판매중 (ON_SALE)</div>
                     <div class="h-1 bg-gray-300 w-24"></div>
                     <div class="z-10 bg-yellow-100 border-2 border-yellow-500 text-yellow-800 px-6 py-3 rounded-lg font-bold">예약중 (RESERVED)</div>
                     <div class="h-1 bg-gray-300 w-24"></div>
                     <div class="z-10 bg-gray-800 text-white px-6 py-3 rounded-lg font-bold">판매완료 (SOLD)</div>
                     <div class="absolute bottom-2 text-xs text-gray-500 w-full text-center">* 트랜잭션은 원자적(Atomic)이어야 합니다. 상태 변경 시 Row-Level Locking 사용 권장.</div>
                </div>`
               },
               {
                    id: 8,
                    type: 'content',
                    title: '8. 실시간 채팅 아키텍처',
                    content: [
                         '전략: HTTP + WebSocket 하이브리드 방식.',
                         '전송 (쓰기): 일반적인 POST 요청 (HTTP). 확실한 수신 확인(Ack) 및 RLS 적용.',
                         '수신 (읽기): Supabase Realtime (WebSocket) 구독.',
                         '파티셔닝: 월별(Month) 테이블 파티셔닝 계획.'
                    ]
               },
               {
                    id: 9,
                    type: 'content',
                    title: '9. 알림 시스템 (Fan-Out on Write)',
                    content: [
                         '동네 새 글 알림: 푸시 모델 사용 시 과부하 발생.',
                         '해결책: 하이브리드 접근법.',
                         '1. 직접 상호작용 (댓글/좋아요): 즉시 Insert.',
                         '2. 대량 이벤트 (지역 새 글): 클라이언트가 Pull 방식(배지 확인)으로 조회.'
                    ]
               },
               {
                    id: 10,
                    type: 'code',
                    title: '10. 보안: 고급 RLS 정책 (Advanced RLS)',
                    description: '채팅방 참여자만 메시지를 읽을 수 있는 보안 정책.',
                    code: `-- 채팅방 참여자만 읽기 가능
CREATE POLICY "Room Members Only"
ON public.messages
FOR SELECT
USING (
  EXISTS (
    SELECT 1 FROM public.room_participants rp
    WHERE rp.room_id = messages.room_id
    AND rp.user_id = auth.uid()
  )
);`
               },
               {
                    id: 11,
                    type: 'diagram',
                    title: '11. 데이터베이스 인덱싱 전략',
                    description: 'B-Tree vs GIN 인덱스 활용법.',
                    htmlContent: `
                 <div class="grid grid-cols-2 gap-4 w-full max-w-3xl mx-auto">
                    <div class="border p-4 rounded bg-blue-50">
                       <div class="font-bold text-blue-800 mb-2">WHERE user_id = '...'</div>
                       <div class="text-sm">표준 <strong>B-TREE</strong> 인덱스. 빠른 정확 일치 검색.</div>
                    </div>
                    <div class="border p-4 rounded bg-purple-50">
                       <div class="font-bold text-purple-800 mb-2">WHERE tags @> ARRAY['hiking']</div>
                       <div class="text-sm"><strong>GIN</strong> 인덱스. 배열 내부 요소 검색에 최적화.</div>
                    </div>
                 </div>`
               },
               {
                    id: 12,
                    type: 'content',
                    title: '12. 포인트/화폐 시스템 (원장 관리)',
                    content: [
                         '패턴: 복식 부기(Double Entry) 또는 추가 전용 로그(Append-Only Log).',
                         '방식: point_history 테이블에 모든 내역(+/-)을 기록하고 잔액은 합산(SUM)으로 계산.',
                         '목적: 사용자의 잔액 문의에 대한 정확한 이력 추적 및 감사(Audit) 가능.'
                    ]
               },
               {
                    id: 13,
                    type: 'content',
                    title: '13. 동창 찾기 로직 (개인정보 보호)',
                    content: [
                         '졸업 연도는 민감 정보(PII)입니다.',
                         '해결책: 졸업 연도 컬럼에 RLS를 적용하여 본인만 조회 가능하게 설정.',
                         '공개 뷰: 정확한 연도 대신 "OOOO년대 학번" 등으로 마스킹하어 노출.'
                    ]
               },
               {
                    id: 14,
                    type: 'content',
                    title: '14. 이미지 스토리지 & CDN',
                    content: [
                         'Supabase Storage (AWS S3) 사용.',
                         'DB에는 파일 경로(Path)만 저장하고, 이미지는 CDN URL로 서빙.',
                         '최적화: 클라이언트 사이드 리사이징 후 업로드.'
                    ]
               },
               {
                    id: 15,
                    type: 'content',
                    title: '15. 위치 기반 서비스 (PostGIS)',
                    content: [
                         '컬럼 타입: GEOGRAPHY(POINT, 4326).',
                         '쿼리: ST_DWithin(location, user_location, 5000) (반경 5km).',
                         '필수 사항: GIST 인덱스를 적용해야 공간 검색 성능 확보.'
                    ]
               },
               {
                    id: 16,
                    type: 'code',
                    title: '16. 크론 작업 & 유지보수',
                    description: 'pg_cron 확장을 이용한 DB 내부 스케줄링.',
                    code: `-- 미인증 유저 정리 (24시간 경과)
SELECT cron.schedule('0 0 * * *', $$
  DELETE FROM auth.users 
  WHERE email_confirmed_at IS NULL 
  AND created_at < NOW() - INTERVAL '24 hours'
$$);`
               },
               {
                    id: 17,
                    type: 'content',
                    title: '17. 백업 & 시점 복구 (PITR)',
                    content: [
                         'WAL 아카이빙 활성화로 최근 7일 내 임의 시점 복구 가능.',
                         '실수로 인한 데이터 삭제 사고 시 필수적인 안전장치.',
                         '매일 다른 리전(Region)으로 스냅샷 백업.'
                    ]
               },
               {
                    id: 18,
                    type: 'title',
                    title: '19. 요약 및 개발 이관',
                    subtitle: '높은 일관성, 읽기 확장성, 제로 트러스트 보안 설계 완료',
                    author: '문서 끝',
                    icon: 'flag'
               }
          ];

          let currentSlide = 0;

          function renderSlide() {
               const slide = slides[currentSlide];
               const app = document.getElementById('app');
               const progress = ((currentSlide + 1) / slides.length) * 100;

               let mainContent = '';

               if (slide.type === 'title') {
                    mainContent = `
                <div class="flex flex-col items-center justify-center h-full text-center space-y-8 animate-in fade-in bg-gradient-to-br from-white to-slate-50 p-10 select-none">
                    <div class="p-8 bg-indigo-50 rounded-full shadow-lg mb-4 ring-8 ring-indigo-50/50">
                         <i data-lucide="${slide.icon}" class="w-16 h-16 text-indigo-600"></i>
                    </div>
                    <h1 class="text-5xl font-black text-slate-800 tracking-tight leading-tight">${slide.title}</h1>
                    <p class="text-2xl text-slate-500 font-light">${slide.subtitle}</p>
                    <div class="mt-12 inline-block px-6 py-2 bg-slate-900 text-white text-sm font-bold uppercase tracking-widest rounded-full shadow-md">${slide.author}</div>
                </div>`;
               } else {
                    mainContent = `
                <div class="flex flex-col h-full p-8 lg:p-12 overflow-hidden">
                    <div class="flex items-center gap-4 border-b border-slate-200 pb-6 mb-6">
                        <div class="bg-indigo-600 text-white w-10 h-10 flex items-center justify-center rounded-lg font-bold text-xl shadow-md shrink-0">${slide.id}</div>
                        <h2 class="text-3xl font-bold text-slate-800 tracking-tight">${slide.title.replace(/^[0-9]+\.\s/, '')}</h2>
                    </div>
                    <div class="flex-1 overflow-y-auto pr-4 custom-scrollbar">
                        ${slide.description ? `<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 rounded-r-lg"><p class="text-lg text-blue-900 font-medium">${slide.description}</p></div>` : ''}
                        
                        ${slide.content ? `<ul class="grid gap-4 mb-8">${slide.content.map(item => `
                            <li class="flex items-start gap-4 p-4 bg-white border border-slate-100 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                                <div class="w-2 h-2 mt-3 bg-indigo-600 rounded-full shrink-0"></div>
                                <span class="text-lg text-slate-700 font-medium">${item}</span>
                            </li>`).join('')}</ul>` : ''}

                        ${slide.bullet_content ? `<ul class="space-y-2 mb-8">${slide.bullet_content.map(item => `
                             <li class="flex items-start gap-2 text-slate-700">
                                 <div class="w-1.5 h-1.5 mt-2.5 bg-slate-400 rounded-full shrink-0"></div>
                                 ${item}
                             </li>`).join('')}</ul>` : ''}
                        
                        ${slide.tables ? `<div class="grid gap-6 mb-8">${slide.tables.map(table => `
                            <div class="border border-slate-200 rounded-xl overflow-hidden shadow-sm bg-white">
                                <div class="bg-slate-800 px-5 py-3 font-mono font-bold text-white flex items-center gap-2 border-b border-slate-700">
                                    <i data-lucide="database" class="w-4 h-4 text-green-400"></i> ${table.name}
                                </div>
                                <div class="p-4 bg-slate-50">
                                    <ul class="space-y-2">
                                        ${table.columns.map(col => `<li class="font-mono text-sm text-slate-700 flex items-center gap-3 py-1 border-b border-slate-200 last:border-0"><span class="w-2 h-2 rounded-full bg-slate-400 shrink-0"></span>${col}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>`).join('')}</div>` : ''}

                        ${slide.code ? `<div class="relative group mb-8"><div class="absolute top-0 right-0 p-2 bg-slate-800 rounded-bl-lg rounded-tr-lg text-xs text-gray-400 font-mono border-l border-b border-gray-700">PGSQL</div><div class="bg-slate-900 text-blue-300 p-6 rounded-xl font-mono text-sm shadow-xl overflow-x-auto ring-1 ring-white/10"><pre>${slide.code}</pre></div></div>` : ''}

                        ${slide.htmlContent ? `<div class="mb-8">${slide.htmlContent}</div>` : ''}
                    </div>
                </div>`;
               }

               app.innerHTML = `
                ${mainContent}
                <div class="h-20 bg-slate-50 border-t border-slate-200 flex items-center justify-between px-8 shrink-0 z-20 absolute bottom-0 w-full">
                    <div class="text-sm font-semibold text-slate-500 font-mono flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> LIVE PREVIEW
                    </div>
                    <div class="flex items-center gap-6">
                        <button onclick="prevSlide()" ${currentSlide === 0 ? 'disabled' : ''} class="p-3 rounded-full hover:bg-white hover:shadow-lg disabled:opacity-30 transition-all">
                            <i data-lucide="chevron-left"></i>
                        </button>
                        <div class="flex flex-col items-center gap-1 w-64">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">Progress</div>
                            <div class="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-600 transition-all duration-500" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <button onclick="nextSlide()" ${currentSlide === slides.length - 1 ? 'disabled' : ''} class="p-3 rounded-full hover:bg-white hover:shadow-lg disabled:opacity-30 transition-all">
                             <i data-lucide="chevron-right"></i>
                        </button>
                    </div>
                    <div class="text-sm font-bold text-slate-400">STANDALONE MODE</div>
                </div>
            `;
               lucide.createIcons();
          }

          function nextSlide() {
               if (currentSlide < slides.length - 1) {
                    currentSlide++;
                    renderSlide();
               }
          }

          function prevSlide() {
               if (currentSlide > 0) {
                    currentSlide--;
                    renderSlide();
               }
          }

          // Init
          window.onload = renderSlide;
     </script>
</body>

</html>